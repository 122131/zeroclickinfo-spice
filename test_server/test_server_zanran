#!/usr/bin/env perl

use HTTP::Daemon;
use HTTP::Status;
use URI;
use URI::QueryParam;
use URI::Escape;

sub handle_search {
  my $r = shift;
  my $query = $r->url->query_param("q");
  my $query_esc = uri_escape($query);
  my $callback_js = "";

  my @spice = ("zanran");
  my @callback_urls = (
    'http://www.zanran.com/search/simple_json?callback=ddg_spice_zanran&q=' . $query_esc,
    'http://duckduckgo.com/d.js?q=' . $query_esc . '&l=wt-wt&s=0&a=i',
    'http://duckduckgo.com/s.js?q=' . $query_esc,
  );
  my $spice_includes = "";
  for(@callback_urls){
    $callback_js .= "nrj('$_');\n";
  }
  for(@spice){
    $spice_includes .= '<script type="text/JavaScript" src="/share/spice/'.$_.'/spice.js"></script>';
  }
  my $html = <<EOF;
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta name="robots" content="noindex,nofollow">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
  <title>$query at DuckDuckGo</title>
  <link rel="stylesheet" href="http://duckduckgo.com/s423.css" type="text/css">
  <style id="DDG" type="text/css"></style>
  <link title="DuckDuckGo" type="application/opensearchdescription+xml" rel="search" href="http://duckduckgo.com/opensearch_ssl.xml">
  <link rel="image_src" href="http://duckduckgo.com/assets/logo_homepage.normal.v101.png"/>
  <link rel="apple-touch-icon" href="http://duckduckgo.com/assets/logo_icon128.v101.png"/>
  <link rel="shortcut icon" href="http://duckduckgo.com/favicon.ico">
  <script type="text/javascript">var fq,r1c,r2c,r3c,ric,rfq,rq,rds,rt,y,y1,ti,tig,ka,kb,kc,kd,ke,kf,kg,kh,ki,kj,kk,kl,km,kn,ko,kp,kq,kr,ks,kt,ku,kv,kw,kx,ky,kz,k1,k2,k3,k4,k5,k6,k7,k8,k9,kaa,kab,kac,kad,kae,kaf,kag,kah,kai,kaj,kak,kal,kam,kan,kao,kap,kaq,kar,kas,kat,kau,kav,kaw,kax,kay,kaz;fq=0;fd=1;it=0;iqa=0;iqm=0;iqs=0;iqq=0;qw=1;r1hc=0;r1c=0;r2c=0;r3c=0;ric=1;rq='$query_esc';rfq=0;rt='';ra='i';rv='';rad='';rds=30;rs=0;kl='wt-wt';kp='';ks='';kw='';ka='';kt='';ky='';kk='';kf='';kc='';ke='';kr='';ko='';kj='';kz='';kg='';kh='';kd='';ki='';kn='';kb='';km='';ku='';kq='';kv='';kx='';k1='';k2='';k3='';k4='';k5='';k6='',k7='',k8='',k9='';kaa='';kab='';kac='';kad='';kae='';kaf='';kag='';kah='';kai='';kaj='';kak='';kal='';kam='';kan='';kao='';kap='';kaq='';kar='';kas='';kat='';kau='';kav='';kaw='';kax='';kay='';kaz='';</script>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <meta name="HandheldFriendly" content="true" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  </head>
  <body class="yui-skin-sam">
    <input id="state_hidden" name="state_hidden" type="text" size="1"><span class="hide">Ignore this box please.</span><div id="spacing_hidden_wrapper">
    <div id="spacing_hidden"></div></div><div id="add_to_browser" class="add_to_browser"></div><div id="add_to_browser_homepage" class="add_to_browser"></div>
    <script type="text/javascript" src="http://duckduckgo.com/d751.js"></script><div id="header_wrapper"><div id="header"><div id="header_content_wrapper">
    <div id="header_content"><div class="clear"></div><a tabindex="-1" href="/?t=i"><div id="header_logo"></div></a><form id="search_form" name="x" action="" onSubmit="return nbr()">
    <div id="search_elements_hidden"></div><div id="search_wrapper"><input id="search_button" type="submit" tabindex="3" value=""/>
    <a id="search_dropdown" href="javascript:;" tabindex="4" onClick="nbc(1);"></a></div><input id="search_form_input_clear" type="button" tabindex="2" value=""/>
    <input type="text" name="q" tabindex="1" autocomplete="off" id="search_form_input" onFocus="if ('rc' in window) {nua('nro',rc)};fq=1;" onBlur="fq=0" onclick="if (this.value=='put search terms here') {this.value='';this.style.color='#000000';}" value="$query">
    <input type="hidden" name="t" value="i"><input type="hidden" name="kl" value="wt-wt"></form><div id="header_button_wrapper" onclick="DDG.toggle('header_button_menu')"><ul id="header_button"><li><div id="header_button_menu_wrapper">
    <a class="header_button_menu_item" id="header_button_menu_title" href="javascript:;">More</a>
    <ul id="header_button_menu"><li><a href="/settings.html" tabindex="-1">Settings</a></li>
      <li><a href="/goodies.html" tabindex="-1">Goodies</a></li>
      <li><a href="/about.html" tabindex="-1">About</a></li><li><a href="http://help.duckduckgo.com/" tabindex="-1">Help</a></li>
      <li><a href="/feedback.html" tabindex="-1">Feedback</a></li>
      <li class="header_button_menu_header">PRIVACY</li><li><a href="http://donttrack.us/" tabindex="-1">DontTrack</a></li>
      <li><a href="http://dontbubble.us/" tabindex="-1">DontBubble</a></li>
      <li><a href="/privacy.html" tabindex="-1">Policy</a></li><li class="header_button_menu_header">COMMUNITY</li>
      <li><a href="https://dukgo.com/" tabindex="-1">Platform</a></li>
      <li><a href="http://duck.co/" tabindex="-1">Forum</a></li><li><a href="http://webchat.freenode.net/?channels=duckduckgo" tabindex="-1">Chat</a></li>
      <li><a href="/spread.html" tabindex="-1">Spread</a></li></ul></div></li>
    </ul></div>
    <div class="clear"></div></div></div></div></div>
    <div id="bang_wrapper"><select id="bang" size="2" onChange="if (ip) nbb(this);" onClick="if (!ip) nbb(this);" onBlur="nbc(1);"></select></div>
    <div id="content_wrapper"><div id="content"><div id="side_wrapper"><div id="side_wrapper2"><div id="side"><div id="side_sponsored" class="hide"></div>
    <div id="side_suggestions" class="hide"></div><div id="keyboard_shortcuts" class="hide"><div style="margin-bottom:15px;">
    <script type="text/JavaScript">nib(0,'','Add to ','<br>',0,0)</script><script type="text/JavaScript">nib(0,'','Set as ','',0,1);</script></div>
    <div class="spacer_bottom_7">Search Syntax</div>s:d &nbsp; &nbsp; sort by date<br>r:uk &nbsp; &nbsp; uk region<br>site: &nbsp; &nbsp; domain search<br>\ search &nbsp; &nbsp; first result<div id="keyboard_shortcuts_more" class="spacer_top_3"><a tabindex="-1" href="javascript:;" onclick="nsh('keyboard_shortcuts_more')">More...</a></div><div id="keyboard_shortcuts_more_hidden" class="hide"><br>r:n &nbsp; &nbsp; turn off region<br>!a search &nbsp; &nbsp; search amazon<br>site:uk &nbsp; &nbsp; .uk pages<br>f: &nbsp; &nbsp; find files<br>t: &nbsp; &nbsp; within title<br>b: &nbsp; &nbsp; within body<br><a target="_blank" href="http://help.duckduckgo.com/customer/portal/articles/300304">More explanation...</a></div></div><div id="feedback_wrapper" class="k_float k_bottom k_right"><a title="Give feedback" tabindex="-1" target="_new" href="/feedback.html" rel="nofollow"><div id="feedback"></div></a></div></div></div></div><div id="zero_click_wrapper" style="display:none;visibility:hidden;"><div id="zero_click"><div id="zero_click_wrapper2"><div id="zero_click_plus_wrapper"><a href="javascript:;" onClick="nra4()" id="zero_click_plus">&nbsp;</a></div><div id="zero_click_header" style="display:none;"></div><div id="zero_click_image" style="display:none;"></div><div id="zero_click_abstract" style="display:none;"></div><div class="clear">&nbsp;</div></div></div></div><div id="links_wrapper"><noscript> &nbsp; &nbsp; This page requires JavaScript. Get the non-JS version <a href="https://duckduckgo.com/html/?q=$query_esc">here</a>.</noscript><div id="links"></div></div><div id="powered_by_wrapper"></div><div id="bottom_spacing2"> </div></div></div>
    <script type="text/javascript">nip();</script><script type="text/javascript">tig=new YAHOO.util.ImageLoader.group('body',null,0.01);</script>

  $spice_includes
  <script type="text/JavaScript">
  function nrji(){
$callback_js;
  };
  if(ir){
    window.addEventListener('load', nrji, false);
  } else {
    nrji();
  }
  </script>

  <div id="z2"> </div>
  <script type="text/JavaScript">if (ip) setTimeout('nuo(1)',500);</script>
  <div id="z"> </div></body>
</html>
EOF

  my $h = HTTP::Headers->new;
  $h->header('Content-Type' => 'text/html');
  my $res = HTTP::Response->new("200", "OK", $h, $html);
  return $res;
}

my $d = new HTTP::Daemon;
print "Please contact me at: <URL:", $d->url, ">\n";
while (my $c = $d->accept) {
  while (my $r = $c->get_request) {
    print "URL: ". $r->url . "\n";
    if ($r->method eq 'GET' and $r->url->path =~ /^\/(share\/spice\/[a-z]+\/spice\.js)$/) {
      $c->send_file_response($1);
    } elsif ($r->url->path eq "/") {
      my $res = handle_search($r);
      $c->send_response($res);
    } else {
      $c->send_error(RC_FORBIDDEN)
    }
    last;
  }
  $c->close;
  undef($c);
}
